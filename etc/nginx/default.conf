# /etc/nginx/default.conf (atau jibas.conf)

server {
    listen 80;
    server_name localhost; # Ganti dengan domain Anda jika perlu, atau _
    root /app; # Root utama server

    # Logging (opsional, bisa di-uncomment jika perlu)
    # access_log /var/log/nginx/host.access.log main;
    # error_log /var/log/nginx/error.log;

    # Pengaturan halaman error default
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html; # Lokasi standar untuk halaman error Nginx
    }

    # Blok utama untuk menangani permintaan ke root /
    # Jika JIBAS HANYA di /jibas, blok ini mungkin tidak terlalu banyak digunakan
    # kecuali untuk file statis di /app (jika ada)
    location / {
        index index.html index.htm index.php;
        try_files $uri $uri/ /index.php?$query_string; # Jika ada index.php di root /app
    }

    # Blok spesifik untuk aplikasi JIBAS yang diakses melalui /jibas/
    location /jibas {
        alias /app/jibas; # Path ke direktori JIBAS di dalam kontainer
        index index.php index.html index.htm; # File index default untuk /jibas
        
        # Mencoba melayani file/direktori secara langsung, jika tidak ditemukan,
        # teruskan ke index.php JIBAS dengan query string asli.
        try_files $uri $uri/ /jibas/index.php?$query_string;

        # Blok untuk memproses file .php di dalam /jibas/
        location ~ ^/jibas/(.+\.php)$ {
            # Coba file secara langsung, jika tidak ada, kembalikan 404
            try_files $uri =404; 
            
            # Path ke direktori JIBAS di dalam kontainer untuk SCRIPT_FILENAME
            # Kita menggunakan variabel agar lebih jelas dan mudah diubah jika perlu
            set $jibas_root /app/jibas;
            fastcgi_param SCRIPT_FILENAME $jibas_root/$1; # $1 adalah bagian (.+\.php) dari regex

            # Teruskan permintaan ke layanan PHP-FPM 'jibasapp' di port 9000
            fastcgi_pass jibasapp:9000;
            
            fastcgi_index index.php; # File index default jika URI adalah direktori
            
            # Sertakan parameter FastCGI standar
            include fastcgi_params;
            
            # Parameter PENTING untuk aplikasi PHP agar tahu URL asli yang diminta klien
            # $http_host akan berisi host:port jika port non-standar (misalnya, domain.com:23252)
            fastcgi_param HTTP_HOST $http_host; 
            
            # Parameter tambahan yang berguna (beberapa mungkin sudah ada di fastcgi_params)
            fastcgi_param SERVER_PORT $server_port; # Port yang didengarkan Nginx (80 di kontainer)
            fastcgi_param SERVER_NAME $server_name; # Nama server dari konfigurasi Nginx
            fastcgi_param REMOTE_ADDR $remote_addr;
            fastcgi_param X-Forwarded-For $proxy_add_x_forwarded_for;
            fastcgi_param X-Forwarded-Proto $scheme;
            # fastcgi_param PATH_INFO $fastcgi_path_info; # Jika JIBAS menggunakan PATH_INFO
        }
    }

    # Blok untuk memproses file .php di root /app (jika ada dan berbeda dari /jibas)
    # Jika Anda TIDAK memiliki file PHP lain di luar /jibas yang perlu diproses,
    # blok ini bisa dihapus atau dikomentari.
    # location ~ \.php$ {
    #     # Perhatian: Blok ini akan menangkap SEMUA .php yang tidak ditangkap oleh blok /jibas di atas.
    #     # Pastikan ini perilaku yang diinginkan.
    #     try_files $uri =404;
    #     fastcgi_split_path_info ^(.+\.php)(/.+)$;
    #     fastcgi_pass jibasapp:9000;
    #     fastcgi_index index.php;
    #     include fastcgi_params;
    #     fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; # $document_root di sini adalah /app
    #     fastcgi_param HTTP_HOST $http_host; # Tambahkan juga di sini jika diperlukan
    #     # fastcgi_param PATH_INFO $fastcgi_path_info;
    # }

    # Tolak akses ke file .htaccess karena Nginx tidak menggunakannya
    location ~ /\.ht {
        deny all;
    }
}
